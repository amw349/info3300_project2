<html>
<head>
<title>P2</title>
<!--<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet"> -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Alegreya Sans', Calibri, sans-serif; margin: auto; background-color: #444444;}
svg { border: solid #ccc 1px; background-color: white; box-shadow: 5px 10px 50px white;}
path.country { fill: #ccc; stroke: #888;; }
#contentWrapper {
    margin: auto;
    text-align: center;
    color: white;
    font-size: 20px;
}
#explanationText {
    margin: auto;
    text-align: center;
    color: white;
    font-size: 25px;   
}
#contraceptiveSlider {
    display: block;
    margin: auto;
    margin-bottom: 10%;
}
#yearsSlider {
    display: block;
    margin: auto;
    margin-bottom: 20%;
}
#showingYears {
    position: absolute;
    margin-top: 32%;
    font-size: 30px;
    color: black;
    font-family: 'Alegreya Sans', Calibri, sans-serif;
    display: block;
    padding-left: 12%;
    font-weight: bolder;
}
h1 {
    color: white;
    box-shadow: 5px 10px 50px white
}
</style>
</head>
<body>

<div id="contentWrapper">
    <div id="header">
        <h1><br>
            Effect of Contraceptive Prevalence on the Percentage of College <br>
            Students Who Are Female
        </h1>
    </div>

    <br>
    <br>
    <div id="explanationText">
        The graph above shows the relationship between access to contraceptives within a country and the percentage of <br>
        college students (from that country) who are female.
        <br><br>
        Use the slider to select a percentage of women who have access to birth control, and we'll find the years that every country on earth 
        <br>
        achieved that level of access (it'll be different for every country).
        <br>
        <br>
        Then, we'll display display the percentage of college students from that country who are female. We'll do this <br>
        5, 7, 10, and 15 years after each country achieves the selected birth control prevalence, as shown by the legend on the graph.
        <br><br>
        If we don't have the data for a given country (either because it doesn't exist in the world bank, or because the country never
        <br>
        achieved that level of contraceptive ubiquity, or because the year doesn't exist yet), then that country will stay grey. Have fun!
        <br>
        <br>
        <br>
    </div>

<script>

var projection = d3.geoMercator().scale(150).translate([675,450]);
var pathGenerator = d3.geoPath().projection(projection);

var geoData;
var contraData;
var enrollData = {};
var countries;
var firstYear;
var enrollmentValues;

function updateFirstYear(newValue) {
	firstYear = {};

	var percentageAchieved;
	contraData.forEach(function(d) {
		percentageAchieved = false;
		var year = 0;
		while(!percentageAchieved && year < 25){
			if(d.Rate[year] > newValue){
				percentageAchieved = true;
			};
			year += 1;
		};
		if(percentageAchieved){
			firstYear[d.ID] = 1990 + year;
		}
		else {
			firstYear[d.ID] = 0;
		}
	});
    console.log("calling usevalues hopefully");
    updateEnrollmentValues(0);
}

// wait function from endmemo.com
function wait(ms)
{
    var d = new Date();
    var d2 = null;
    do { d2 = new Date(); }
    while (d2-d < ms);
}
    
function yearShow() {
    console.log("called yearShow");
    var inc = 0
    var max = 6;
    var delay = 1000;
    var toWord = 500;

        
        function timeoutLoop() {
            console.log("inside timeoutloop");
            var theYears = [0, 5, 7, 10, 15];

            // replacing 'after XX years' svg element
            var first = "After ";
            if (theYears[inc] == 5) {
                toWord = "Five";
            }
            else if (theYears[inc] == 10) {
                toWord = "Ten";
            }
            else if (theYears[inc] == 7) {
                toWord = "Seven";
            }
            else if (theYears[inc] == 15) {
                toWord = "Fifteen";
            }
            else if (theYears[inc] == 0) {
                toWord = "Zero";
            }
            var second = first.concat(toWord);
            var third = " Years"
            var last = second.concat(third)
            if (toWord == 500){
                document.getElementById("showingYears").innerHTML = "";
            }
            else {
                document.getElementById("showingYears").innerHTML = last;
            }
                console.log("inc: " + inc);
                console.log("max: " + max);
                if (++inc < max) {
                    setTimeout(timeoutLoop, delay)
                }
            }
    console.log("first timeout");
    setTimeout(timeoutLoop, delay)
}

function updateEnrollmentValues(yearsPlus) {
	enrollmentValues = {}
	for(key in firstYear){
        	var yearAchieved = firstYear[key];
        	var yearIndex = yearAchieved - 1990 + yearsPlus;
        	if (enrollData[key] != undefined){
        		console.log(yearIndex)
        		if (yearIndex >= 0 && yearIndex < enrollData[key].length){
	        		var enrollPercent = enrollData[key][yearIndex];
	        		enrollmentValues[key] = enrollPercent;
	        	}
	        	else {
	        		enrollmentValues[key] = -1;
	        	}
    		}
        }
    console.log(enrollmentValues["USA"])
    updateMap();
}

function updateMap() {

}

function useValues(yearDictionary) {
    console.log("called useValues");
    yearShow()
    console.log("after yearShow");
    // looping through the years we want to display
    var theYears = [0, 5, 7, 10, 15];
    for (year = 0; year < theYears.length; year++) {
        var yearsPlus = parseInt(theYears[year]);
        

        // (needs loop) for each country in dict, take value, add the yearsPlus int, and find country's
        // enrollment ratio 
        // console.log(yearDictionary)
        // for(key in yearDictionary){
        // 	var yearAchieved = yearDictionary[key];
        // 	console.log(key);
        // 	console.log(yearAchieved);
        // 	console.log(enrollData[key])
        // 	//console.log(enrollData[key][yearAchieved - 1990 + yearsPlus])
        // }

        // put that ratio in the map

        for(key in firstYear){
        	var yearAchieved = firstYear[key];
        	var yearIndex = yearAchieved - 1990 + yearsPlus;
        	//console.log(key);
        	//console.log(yearAchieved);
        	//console.log(yearSelected);
        	//console.log(enrollData[key]);
        	if (enrollData[key] != undefined && yearIndex < enrollData[key].length){
        		var enrollPercent = enrollData[key][yearIndex];
        		//console.log(enrollPercent)
    		}
        }



        // pausing for 5 seconds before displaying the next year
        // (using wait function from endmemo.com)

        wait(1000);
    } // end loop
}

function parse(row){
    // version 1:
    var rate = []
    for (i in row) {
        if (i != "Country" && i != "ID") {
            row[i] = Number(row[i]);
            rate.push(Number(row[i]));
        }
    }
    row["Rate"] = rate;
    return row
}

//code based from lecture and http://www.tnoda.com/blog/2013-12-07
//data from https://raw.githubusercontent.com/yaph/d3-geomap/master/src/topojson/world/countries.json

d3.queue()
.defer(d3.json, "world.json")
.defer(d3.csv, "birth_control_country_data.csv?v1", parse)
.defer(d3.csv, "enrollment.csv?v2", parse)
.await(function (error, worldData, csvData, csvData2) {

	geoData = worldData;
	contraData = csvData;

	csvData2.forEach(function(d) {
		enrollData[d.ID] = d.Rate;
	})

    var svg = d3.select("#contentWrapper")
        .append("svg")
        .attr("height", "650")
        .attr("width", "1400");

    svg.append("text")
        .attr("id", "CountryName")
        .attr("x", 10)
        .attr("y", 28)
        .style("font-size", "18pt");
	
    svg.append("text")
	    .attr("id", "FirstYear")
	    .attr("x", 10)
	    .attr("y", 48)
	    .style("font-size", "18pt");

	countries = topojson.feature(geoData, geoData.objects.units);
	svg.append("g")
        .attr("id", "countries")
        .selectAll("path.country")
        .data(countries.features)
        .enter()
        .append("path")
        .attr("class", "country")
        .attr("id", function(d) { return d.properties.name; })
        .attr("d", function (country) {
            if(country.properties.name != "Antarctica")
        	return pathGenerator(country);
        })
        .on("mouseover", function(country){
            this.style.opacity = 0.7
        	svg.select("#CountryName").text(country.properties.name);
            svg.select("#FirstYear").text(firstYear[country.id])
        })
        .on("mouseout", function(country){
            this.style.opacity = 1;
        })
        .style("fill", function(d) {
        	//CHANGE use data from contraData to get different shadings
        	//something like
        	//return color (pairRateWithId[d.id]);
        	//https://suffenus.wordpress.com/2014/01/07/making-interactive-maps-with-d3-for-total-beginners/
        	return "light grey";
        });

    var slider = d3.select("body")
            .append("div")
            .attr("id", "slider")

    slider.append("text")
            .append("input")            
            .attr("type", "range")
            .attr("name", "contraceptiveSlider")
            .attr("min", "0")
            .attr("max", "90")
            .attr("value", "0") // default/starting value
            .attr("step", "1")
            .attr("id", "contraceptiveSlider")
            .style("width", "420px")
            .on("input", function() { 
                value = this.value;
            });

    slider.append("text")
            .append("input")            
            .attr("type", "range")
            .attr("name", "yearsSlider")
            .attr("min", "0")
            .attr("max", "15")
            .attr("value", "0") // default/starting value
            .attr("step", "1")
            .attr("id", "yearsSlider")
            .style("width", "420px")
            .on("input", function() { 
                value = this.value;
            });

    var contraceptiveSlider = document.getElementById("contraceptiveSlider")
    var yearsSlider = document.getElementById("yearsSlider")

    contraceptiveSlider.oninput = function() {
        console.log("contraceptiveSlider val:" + contraceptiveSlider.value);
        document.getElementById("showingYears").innerHTML = String(contraceptiveSlider.value);
        updateFirstYear(contraceptiveSlider.value);
     };

     yearsSlider.oninput = function() {
     	updateEnrollmentValues(yearsSlider.vaule)
     	console.log("yearsSlider val:" + yearsSlider.value);
     }


    

    // svg.append("text")
    // .attr("id", "yearsAfter")
    // .attr("x", 80)
    // .attr("y", 600)
    // .style("font-size", "30pt");
    // svg.select("#yearsAfter").text("After Fifteen Years");
    updateFirstYear(contraceptiveSlider.value);

})


</script>
    <br>
    <div id="showingYears">
        After Fifteen Years
    </div>
    </div>
    <br><br>
</body>
</html>