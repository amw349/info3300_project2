<html>
<head>
<title>P2</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Alegreya Sans', Calibri, sans-serif; margin: auto; background-color: #444444;}
svg { border: solid #ccc 1px; background-color: white; box-shadow: 5px 10px 50px white;}
path.country { fill: #ccc; stroke: #888;; }
#mainCenter {
    margin: auto;
    text-align: center;
    color: white;
    font-size: 20px;
}
#explanationText {
    margin: auto;
    text-align: center;
    color: white;
    font-size: 25px;   
}
h1 {
    color: white;
    box-shadow: 5px 10px 50px white
}
</style>
</head>
<body>

<div id="mainCenter">
    <h1><br>
        Effect of Contraceptive Prevalence on the Percentage of College <br>
        Students Who Are Female
    </h1>

<svg height="650" width="1400">
</svg>
    <input type="range" name='politics' min="0" max="90" value="0" step="1" style='width:420px' onchange="showValue(this.value); takeValue(this.value);" />
    <span id="range">&nbsp; &nbsp; &nbsp; &nbsp; 0%</span>
    <script type="text/javascript">
    function showValue(newValue){
        document.getElementById("range").innerHTML = String(newValue).concat("%");
    }
    </script>
    <br>
    <br>
    <div id="explanationText">
        The graph above shows the relationship between access to contraceptives within a country and the percentage of <br>
        college students (from that country) who are female.
        <br><br>
        Use the slider to select a percentage of women who have access to birth control, and we'll find the years that every country on earth 
        <br>
        achieved that level of access (it'll be different for every country).
        <br>
        <br>
        Then, we'll display display the percentage of college students from that country who are female. We'll do this <br>
        5, 7, 10, and 15 years after each country achieves the selected birth control prevalence, as shown by the legend on the graph.
        <br><br>
        If we don't have the data for a given country (either because it doesn't exist in the world bank, or because the country never
        <br>
        achieved that level of contraceptive ubiquity, or because the year doesn't exist yet), then that country will stay grey. Have fun!
        <br>
        <br>
        <br>
    </div>
</div>


<script id="make_map">

var svg = d3.select("svg");
svg.append("text")
.attr("id", "CountryName")
.attr("x", 10)
.attr("y", 28)
.style("font-size", "18pt");

svg.append("text")
.attr("id", "FirstYear")
.attr("x", 10)
.attr("y", 48)
.style("font-size", "18pt");

svg.append("text")
.attr("id", "yearsAfter")
.attr("x", 80)
.attr("y", 600)
.style("font-size", "30pt");
svg.select("#yearsAfter").text("After Fifteen Years");


var projection = d3.geoMercator().scale(150).translate([675,450]);
var pathGenerator = d3.geoPath().projection(projection);

var geoData;
var contraData;
var countries;
var firstYear;

function takeValue(newValue) {
	firstYear = {};
	var percentageAchieved;
	contraData.forEach(function(d) {
		percentageAchieved = false;
		var year = 0;
		while(!percentageAchieved && year < 25){
			if(d.Rate[year] > newValue){
				percentageAchieved = true;
			};
			year += 1;
		};
		if(percentageAchieved){
			firstYear[d.Country] = 1990 + year;
		}
		else {
			firstYear[d.Country] = 0;
		}
	});
}


function parseLine(line) {
	return {
	  Country: line["Country"],
	  Rate: [Number(line["1990"]),
	  Number(line["1991"]),
	  Number(line["1992"]),
	  Number(line["1993"]),
	  Number(line["1994"]),
	  Number(line["1995"]),
	  Number(line["1996"]),
	  Number(line["1997"]),
	  Number(line["1998"]),
	  Number(line["1999"]),
	  Number(line["2000"]),
	  Number(line["2001"]),
	  Number(line["2002"]),
	  Number(line["2003"]),
	  Number(line["2004"]),
	  Number(line["2005"]),
	  Number(line["2006"]),
	  Number(line["2007"]),
	  Number(line["2008"]),
	  Number(line["2009"]),
	  Number(line["2010"]),
	  Number(line["2011"]),
	  Number(line["2012"]),
	  Number(line["2013"]), 
	  Number(line["2014"])]
	};
};

//code based from lecture and http://www.tnoda.com/blog/2013-12-07
//data from https://raw.githubusercontent.com/yaph/d3-geomap/master/src/topojson/world/countries.json

d3.queue()
.defer(d3.json, "world.json")
.defer(d3.csv, "birth_control_country_data.csv?v1", parseLine)
.await(function (error, worldData, csvData) {

	geoData = worldData;
	contraData = csvData;

	
	countries = topojson.feature(geoData, geoData.objects.units);
	svg.append("g")
    .attr("id", "countries")
    .selectAll("path.country")
    .data(countries.features)
    .enter()
    .append("path")
    .attr("class", "country")
    .attr("id", function(d) { return d.properties.name; })
    .attr("d", function (country) {
        if(country.properties.name != "Antarctica")
    	return pathGenerator(country);
    })
    .on("mouseover", function(country){
        	this.style.opacity = 0.7
        	svg.select("#CountryName").text(country.properties.name);
        	svg.select("#FirstYear").text(firstYear[country.properties.name])

        })
    .on("mouseout", function(country){
        	this.style.opacity = 1;
    	})
    .style("fill", function(d) {
    	//CHANGE use data from contraData to get different shadings
    	//something like
    	//return color (pairRateWithId[d.id]);
    	//https://suffenus.wordpress.com/2014/01/07/making-interactive-maps-with-d3-for-total-beginners/
    	return "light grey";
    });
})


</script>
</body>
</html>